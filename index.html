<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Printer</title>
  <style>
    body {
      background: #08151d;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 40px;
      margin: 0;
      min-height: 100vh;
    }

    h1 {
      margin-bottom: 40px;
      color: #fff;
      font-size: 2em;
      letter-spacing: 2px;
    }

    .printer {
      width: 350px;
      height: 250px;
      background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      margin: 0 auto;
      border-radius: 15px;
      position: relative;
      box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.5),
        inset 0 -2px 10px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      border: 2px solid #444;
    }

    .printer::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 8px;
      background: #0a0;
      border-radius: 4px;
      box-shadow: 0 0 10px #0a0;
    }

    .printer::after {
      content: 'lilRoby';
      position: absolute;
      top: 35px;
      left: 50%;
      transform: translateX(-50%);
      color: #888;
      font-size: 12px;
      letter-spacing: 3px;
    }

    .slot {
      width: 280px;
      height: 3px;
      background: #000;
      position: absolute;
      top: 110px;
      left: 35px;
      border-radius: 2px;
      z-index: 10;
      box-shadow: 
        0 2px 5px rgba(0, 0, 0, 0.5) inset,
        0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .paper-wrapper {
      position: absolute;
      top: 110px;
      left: 35px;
      width: 280px;
      height: 300px;
      overflow: visible;
      z-index: 1;
    }

    .paper {
      width: 280px;
      background: white;
      position: absolute;
      top: 0;
      left: 0;
      transition: transform 4s ease-in-out;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      padding: 20px;
      box-sizing: border-box;
    }

    .paper.printing {
      transform: translateY(320px);
    }

    .paper::before,
    .paper::after {
      content: '';
      position: absolute;
      left: 0;
      width: 100%;
      height: 8px;
      background: 
        linear-gradient(45deg, transparent 33.33%, white 33.33%, white 66.66%, transparent 66.66%),
        linear-gradient(-45deg, transparent 33.33%, white 33.33%, white 66.66%, transparent 66.66%);
      background-size: 10px 8px;
      background-position: 0 0, 5px 0;
    }

    .paper::before {
      top: -8px;
    }

    .paper::after {
      bottom: -8px;
    }

    .paper img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 15px;
      border: 1px solid #ddd;
    }

    .print-title {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
      color: #000;
      text-align: left;
    }

    .print-message {
      font-size: 14px;
      margin: 8px 0;
      color: #333;
      text-align: left;
      line-height: 1.4;
    }

    .print-name {
      font-size: 14px;
      margin: 8px 0;
      color: #333;
      text-align: left;
      font-style: italic;
    }

    .print-id {
      font-size: 14px;
      margin-top: 15px;
      color: #666;
      text-align: left;
    }

    #output-area {
      margin-top: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      padding-bottom: 40px;
    }

    #output-area .paper {
      position: static;
      transform: none;
      transition: none;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .controls {
      margin-top: 30px;
    }

    .controls button {
      background: #444;
      color: #fff;
      border: 1px solid #666;
      padding: 10px 20px;
      margin: 0 10px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
    }

    .controls button:hover {
      background: #555;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .status {
      color: #888;
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h1>lilRoby Virtual Printer</h1>

  <div class="printer">
    <div class="slot"></div>
    <div class="paper-wrapper" id="paper-wrapper"></div>
  </div>

  <div class="controls">
    <button onclick="clearAllPrints()">Clear All Prints</button>
  </div>

  <div class="status" id="status">Connecting...</div>

  <div id="output-area"></div>

  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

  <script>
    const paperWrapper = document.getElementById('paper-wrapper');
    const outputArea = document.getElementById('output-area');
    const statusEl = document.getElementById('status');

    function loadPrints() {
      const stored = localStorage.getItem('lilroby_prints');
      return stored ? JSON.parse(stored) : [];
    }

    function savePrints(prints) {
      localStorage.setItem('lilroby_prints', JSON.stringify(prints));
    }

    function displayStoredPrints() {
      const prints = loadPrints();
      prints.forEach(printData => {
        createPrintElement(printData, true);
      });
    }

    function createPrintElement(data, isStored = false) {
      const imageUrl = `http://wokki20.nl/lilroby/api/v1/prints/${data.unique_image_id}.webp`;

      const paper = document.createElement('div');
      paper.classList.add('paper');

      let content = `<img src="${imageUrl}" alt="Print">`;
      
      if (data.title) {
        content += `<div class="print-title">${escapeHtml(data.title)}</div>`;
      }
      
      if (data.message) {
        content += `<div class="print-message">${escapeHtml(data.message)}</div>`;
      }
      
      if (data.name) {
        content += `<div class="print-name">â€” ${escapeHtml(data.name)}</div>`;
      }
      
      if (data.print_id) {
        content += `<div class="print-id">Print #${data.print_id}</div>`;
      }

      paper.innerHTML = content;

      if (isStored) {
        outputArea.appendChild(paper);
      } else {
        paperWrapper.appendChild(paper);

        requestAnimationFrame(() => {
          paper.classList.add('printing');
        });

        setTimeout(() => {
          outputArea.insertBefore(paper, outputArea.firstChild);
          paper.style.position = 'static';
          paper.style.transform = 'none';
          paper.style.transition = 'none';
        }, 4000);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function clearAllPrints() {
      if (confirm('Are you sure you want to clear all prints?')) {
        localStorage.removeItem('lilroby_prints');
        outputArea.innerHTML = '';
        statusEl.textContent = 'All prints cleared';
        setTimeout(() => {
          statusEl.textContent = 'Connected';
        }, 2000);
      }
    }

    const socket = io('https://lilroby-printing.onrender.com');

    socket.on('connect', () => {
      console.log('Connected to Socket.IO');
      statusEl.textContent = 'Connected';
    });

    socket.on('new_data', (data) => {
      console.log('New print received:', data);
      
      const prints = loadPrints();
      prints.unshift(data);
      savePrints(prints);

      createPrintElement(data, false);

      statusEl.textContent = `New print received: #${data.print_id}`;
      setTimeout(() => {
        statusEl.textContent = 'Connected';
      }, 3000);
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from Socket.IO');
      statusEl.textContent = 'Disconnected - Reconnecting...';
    });

    setInterval(() => {
      socket.emit('request-new-image', 'Requesting new image');
    }, 10000);

    displayStoredPrints();
  </script>

</body>
</html>
