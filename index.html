<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>lilRoby 3D Virtual Printer</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #dfe9f3 0%, #ffffff 100%);
      overflow: hidden;
      font-family: sans-serif;
    }
    canvas {
      display: block;
    }
    #output-area {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 10;
    }
  </style>
</head>
<body>
<div id="output-area">Waiting for print jobs...</div>
<audio id="print-sound" src="https://www.myinstants.com/media/sounds/printer-sound.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<script>
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.1;

  const ambientLight = new THREE.AmbientLight(0xffffff, 1);
  scene.add(ambientLight);

  camera.position.set(0, 2, 5);
  controls.update();

  const loader = new THREE.GLTFLoader();
  let printer;
  loader.load('/mnt/data/3d_model_extracted/97029.glb', function (gltf) {
    printer = gltf.scene;
    printer.scale.set(1, 1, 1);
    scene.add(printer);
  });

  // Paper printing animation placeholder
  const paperGeometry = new THREE.PlaneGeometry(1.5, 1);
  const paperMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
  const paper = new THREE.Mesh(paperGeometry, paperMaterial);
  paper.position.set(0, -0.5, 0);
  paper.rotation.x = -Math.PI / 2;
  paper.visible = false;
  scene.add(paper);

  function printPaper() {
    paper.visible = true;
    paper.position.y = -0.5;
    const printSound = document.getElementById('print-sound');
    printSound.play().catch(() => {});

    const interval = setInterval(() => {
      paper.position.y += 0.01;
      if (paper.position.y >= 0.5) {
        clearInterval(interval);
        setTimeout(() => paper.visible = false, 2000);
      }
    }, 16);
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  const outputArea = document.getElementById('output-area');
  const socket = io('https://lilroby-printing.onrender.com');

  socket.on('connect', () => {
    console.log('Connected to Socket.IO');
  });

  socket.on('new_data', (data) => {
    printPaper();
    outputArea.innerHTML = `
      <strong>${data.title}</strong><br>
      From: ${data.name}<br>
      Message: ${data.message}<br>
      Post ID: ${data.post_id}
    `;
  });

  socket.on('disconnect', () => {
    console.log('Disconnected from Socket.IO');
  });

  setInterval(() => {
    socket.emit('request-new-image', 'Requesting new image');
  }, 10000);
</script>
</body>
</html>
