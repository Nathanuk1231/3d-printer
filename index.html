<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Printer</title>
  <style>
    body {
      background: #08151d;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 40px;
      margin: 0;
      min-height: 100vh;
    }

    h1 {
      margin-bottom: 40px;
      color: #fff;
      font-size: 2em;
      letter-spacing: 2px;
    }

    #printer-container {
      width: 600px;
      height: 400px;
      margin: 0 auto;
      position: relative;
    }

    #printer-canvas {
      width: 100%;
      height: 100%;
    }

    .paper-output {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      height: 0;
      overflow: visible;
      z-index: 100;
    }

    .paper {
      width: 280px;
      background: white;
      position: absolute;
      bottom: 0;
      left: 0;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      padding: 20px;
      box-sizing: border-box;
      transform: translateY(100%);
    }

    .paper.printing {
      animation: printOut 4s ease-out forwards;
    }

    @keyframes printOut {
      0% {
        transform: translateY(100%);
      }
      100% {
        transform: translateY(0);
      }
    }

    .paper::before,
    .paper::after {
      content: '';
      position: absolute;
      left: -8px;
      right: -8px;
      width: calc(100% + 16px);
      height: 8px;
      background-image: 
        repeating-linear-gradient(
          90deg,
          white 0px,
          white 5px,
          transparent 5px,
          transparent 10px
        );
    }

    .paper::before {
      top: 0;
      background-image: 
        radial-gradient(circle at 5px 0px, transparent 4px, white 4px);
      background-size: 10px 8px;
      background-repeat: repeat-x;
      background-position: 0 0;
    }

    .paper::after {
      bottom: 0;
      background-image: 
        radial-gradient(circle at 5px 8px, transparent 4px, white 4px);
      background-size: 10px 8px;
      background-repeat: repeat-x;
      background-position: 0 0;
    }

    .paper img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 15px;
      border: 1px solid #ddd;
    }

    .print-title {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
      color: #000;
      text-align: left;
    }

    .print-message {
      font-size: 14px;
      margin: 8px 0;
      color: #333;
      text-align: left;
      line-height: 1.4;
    }

    .print-name {
      font-size: 14px;
      margin: 8px 0;
      color: #333;
      text-align: left;
      font-style: italic;
    }

    .print-id {
      font-size: 14px;
      margin-top: 15px;
      color: #666;
      text-align: left;
    }

    #output-area {
      margin-top: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      padding-bottom: 40px;
    }

    #output-area .paper {
      position: static;
      transform: none;
      animation: none;
      opacity: 0;
      animation: fadeIn 0.5s ease-in forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .controls {
      margin-top: 30px;
    }

    .controls button {
      background: #444;
      color: #fff;
      border: 1px solid #666;
      padding: 10px 20px;
      margin: 0 10px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
    }

    .controls button:hover {
      background: #555;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .status {
      color: #888;
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h1>lilRoby Virtual Printer</h1>

  <div id="printer-container">
    <canvas id="printer-canvas"></canvas>
    <div class="paper-output" id="paper-output"></div>
  </div>

  <div class="controls">
    <button onclick="clearAllPrints()">Clear All Prints</button>
  </div>

  <div class="status" id="status">Connecting...</div>

  <div id="output-area"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

  <script>
    const paperOutput = document.getElementById('paper-output');
    const outputArea = document.getElementById('output-area');
    const statusEl = document.getElementById('status');

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 600 / 400, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ 
      canvas: document.getElementById('printer-canvas'),
      antialias: true,
      alpha: true
    });
    
    renderer.setSize(600, 400);
    renderer.setClearColor(0x08151d, 1);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 10, 5);
    scene.add(directionalLight);

    const pointLight = new THREE.PointLight(0x00ff00, 0.5);
    pointLight.position.set(0, 2, 0);
    scene.add(pointLight);

    camera.position.set(0, 3, 8);
    camera.lookAt(0, 0, 0);

    const loader = new THREE.GLTFLoader();
    loader.load('/models/97029.glb', function(gltf) {
      const model = gltf.scene;
      
      const box = new THREE.Box3().setFromObject(model);
      const center = box.getCenter(new THREE.Vector3());
      model.position.sub(center);
      
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const scale = 4 / maxDim;
      model.scale.set(scale, scale, scale);
      
      scene.add(model);
    }, undefined, function(error) {
      console.error('Error loading model:', error);
    });

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    function loadPrints() {
      const stored = localStorage.getItem('lilroby_prints');
      return stored ? JSON.parse(stored) : [];
    }

    function savePrints(prints) {
      localStorage.setItem('lilroby_prints', JSON.stringify(prints));
    }

    function displayStoredPrints() {
      const prints = loadPrints();
      prints.forEach(printData => {
        createPrintElement(printData, true);
      });
    }

    function createPrintElement(data, isStored = false) {
      const imageUrl = `http://wokki20.nl/lilroby/api/v1/prints/${data.unique_image_id}.webp`;

      const paper = document.createElement('div');
      paper.classList.add('paper');

      let content = `<img src="${imageUrl}" alt="Print">`;
      
      if (data.title) {
        content += `<div class="print-title">${escapeHtml(data.title)}</div>`;
      }
      
      if (data.message) {
        content += `<div class="print-message">${escapeHtml(data.message)}</div>`;
      }
      
      if (data.name) {
        content += `<div class="print-name">â€” ${escapeHtml(data.name)}</div>`;
      }
      
      if (data.print_id) {
        content += `<div class="print-id">Print #${data.print_id}</div>`;
      }

      paper.innerHTML = content;

      if (isStored) {
        outputArea.appendChild(paper);
      } else {
        paperOutput.appendChild(paper);

        requestAnimationFrame(() => {
          paper.classList.add('printing');
        });

        setTimeout(() => {
          paper.classList.remove('printing');
          paperOutput.removeChild(paper);
          outputArea.insertBefore(paper, outputArea.firstChild);
        }, 4000);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function clearAllPrints() {
      if (confirm('Are you sure you want to clear all prints?')) {
        localStorage.removeItem('lilroby_prints');
        outputArea.innerHTML = '';
        statusEl.textContent = 'All prints cleared';
        setTimeout(() => {
          statusEl.textContent = 'Connected';
        }, 2000);
      }
    }

    const socket = io('https://lilroby-printing.onrender.com');

    socket.on('connect', () => {
      console.log('Connected to Socket.IO');
      statusEl.textContent = 'Connected';
    });

    socket.on('new_data', (data) => {
      console.log('New print received:', data);
      
      const prints = loadPrints();
      prints.unshift(data);
      savePrints(prints);

      createPrintElement(data, false);

      statusEl.textContent = `New print received: #${data.print_id}`;
      setTimeout(() => {
        statusEl.textContent = 'Connected';
      }, 3000);
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from Socket.IO');
      statusEl.textContent = 'Disconnected - Reconnecting...';
    });

    setInterval(() => {
      socket.emit('request-new-image', 'Requesting new image');
    }, 10000);

    displayStoredPrints();
  </script>

</body>
</html>
